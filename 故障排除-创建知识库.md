# 创建知识库失败 - 故障排除指南

## 当前问题

创建知识库时遇到 500 错误

## 诊断步骤

### 步骤1：确认选择的嵌入模型

在"创建知识库"对话框中，你选择的嵌入模型是什么？

#### 选项A：本地免费模型（如 BGE-base-zh-v1.5）

**可能原因**：
1. 首次使用需要下载模型文件（~400MB）
2. 网络问题导致下载失败
3. 模型文件损坏

**解决方案**：
```bash
# 手动下载模型（可选）
python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('BAAI/bge-base-zh-v1.5')"
```

#### 选项B：智谱AI嵌入模型（zhipuai-embedding）

**可能原因**：
1. API密钥无效或过期
2. 账户余额不足
3. 网络连接问题

**解决方案**：
- 检查智谱AI API密钥配置
- 确认账户有余额
- 测试网络连接

### 步骤2：检查服务器日志

查看服务器终端的最新输出，找到具体的错误信息：

```
# 在服务器终端中查找错误
# 应该能看到类似这样的日志：
ERROR - 从文件创建知识库索引失败 xxx: [具体错误信息]
```

### 步骤3：尝试不同的嵌入模型

如果本地模型失败，可以先用智谱AI模型测试：

1. 打开"创建知识库"对话框
2. 嵌入模型选择：**zhipuai-embedding**
3. 继续创建

### 步骤4：检查文件上传

确认文件已成功上传到 uploads 目录：

```bash
# Windows PowerShell
Get-ChildItem "d:\WorkSpace\hisAgent\uploads" | Select-Object Name, Length
```

应该能看到你上传的文件。

## 常见错误及解决方法

### 错误1：No module named 'xxx'

**原因**：依赖库未安装

**解决**：
```bash
pip install llama-index-embeddings-huggingface
```

### 错误2：Connection timeout / Network error

**原因**：
- 下载模型文件超时
- 网络连接问题

**解决**：
1. 检查网络连接
2. 使用国内镜像源
3. 等待模型下载完成（可能需要1-5分钟）

### 错误3：余额不足或无可用资源包

**原因**：智谱AI账户余额不足

**解决**：
- 充值智谱AI账户
- 或使用本地免费模型

### 错误4：文件不存在

**原因**：文件上传失败或被清理

**解决**：
1. 重新上传文件
2. 检查 uploads 目录权限

## 推荐操作流程

### 方案1：使用本地免费模型（推荐）

1. **选择嵌入模型**：BGE-base-zh-v1.5（中文，平衡）
2. **首次使用**：系统会自动下载模型文件（~400MB，1-5分钟）
3. **等待下载**：耐心等待，不要关闭浏览器
4. **处理文档**：下载完成后自动开始处理

### 方案2：使用智谱AI模型

1. **选择嵌入模型**：zhipuai-embedding
2. **确保账户有余额**
3. **直接创建**

## 需要的信息

为了帮你诊断问题，请提供：

1. **选择的嵌入模型**：本地免费模型还是智谱AI？
2. **服务器错误日志**：服务器终端显示的错误信息
3. **文件上传状态**：uploads目录中有文件吗？
4. **浏览器控制台日志**：按F12打开开发者工具，查看Console标签的错误

## 快速测试

如果你想快速测试系统是否正常工作：

1. 使用最小的测试文件（如 test_upload.txt）
2. 选择智谱AI嵌入模型（如果账户有余额）
3. 尝试创建知识库

如果智谱AI模型可以工作，说明系统正常，只是本地模型有问题。