# HIS开发Agent

基于智谱4.7大模型的HIS系统开发智能助手，支持IDE（Trae、IDEA）调用。

## 功能特性

- 集成智谱AI GLM-4大模型
- 基于LlamaIndex的知识库管理
- 可配置的提示词管理系统
- 向量数据库支持（Chroma）
- 专业的HIS业务知识
- RESTful API接口，支持IDE调用
- Web管理界面

## 技术栈

- Python 3.10+
- FastAPI
- ZhipuAI SDK
- LlamaIndex
- ChromaDB
- SQLAlchemy
- Vue.js 3（前端）

## 项目结构

```
hisAgent/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI应用入口
│   ├── api/                    # API路由层
│   │   ├── __init__.py
│   │   ├── routes.py           # 统一路由注册
│   │   ├── llm.py              # LLM相关API
│   │   ├── knowledge.py        # 知识库管理API
│   │   ├── prompt.py           # 提示词管理API
│   │   └── his.py              # HIS业务API
│   ├── core/                   # 核心业务层
│   │   ├── __init__.py
│   │   ├── llm_service.py      # LLM服务封装
│   │   ├── knowledge_base.py   # 知识库管理
│   │   ├── prompt_manager.py   # 提示词管理
│   │   └── his_expert.py       # HIS专家系统
│   ├── models/                 # 数据模型层
│   │   ├── __init__.py
│   │   ├── database.py         # 数据库配置
│   │   └── schemas.py          # Pydantic模型
│   ├── utils/                  # 工具层
│   │   ├── __init__.py
│   │   ├── logger.py           # 日志工具
│   │   └── helpers.py          # 辅助函数
│   └── config.py               # 应用配置
├── frontend/                   # 前端管理界面
│   └── index.html              # 管理页面
├── .env.example                # 环境变量示例
├── requirements.txt            # Python依赖
├── .python-version            # Python版本控制
└── README.md                   # 项目说明
```

## 快速开始

### 1. 安装依赖

#### 方式一：使用Anaconda（推荐）

```bash
# 创建并激活conda环境
conda env create -f environment.yml
conda activate hisagent
```

#### 方式二：使用pip

```bash
# 确保使用Python 3.10
python --version

# 安装依赖
pip install -r requirements.txt
```

### 2. 配置环境变量

```bash
# 复制环境变量示例文件
cp .env.example .env

# 编辑.env文件，填入API密钥
# 必填：ZHIPUAI_API_KEY
# 可选：OPENAI_API_KEY（用于Embedding）
```

### 3. 启动服务

```bash
# 启动服务
python -m app.main

# 或使用uvicorn
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

服务启动后可以访问：
- API文档: http://localhost:8000/docs
- 管理界面: http://localhost:8000/admin

## API使用

### 基础对话

```bash
curl -X POST http://localhost:8000/api/v1/llm/chat \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      {"role": "user", "content": "你好"}
    ]
  }'
```

### HIS代码审查

```bash
curl -X POST http://localhost:8000/api/v1/his/code-review \
  -H "Content-Type: application/json" \
  -d '{
    "code_path": "src/medical/OrderService.java",
    "code_content": "public class OrderService { ... }"
  }'
```

### HIS知识问答

```bash
curl -X POST http://localhost:8000/api/v1/his/knowledge-qa \
  -H "Content-Type: application/json" \
  -d '{
    "question": "什么是HL7标准？"
  }'
```

### HIS开发助手

```bash
curl -X POST http://localhost:8000/api/v1/his/development-assistant \
  -H "Content-Type: application/json" \
  -d '{
    "requirement": "实现门诊挂号功能",
    "context": "需要支持医保结算"
  }'
```

## IDE集成

### Trae插件配置

在Trae中配置自定义AI服务：

1. 打开Trae设置 -> AI配置
2. 添加自定义API端点：`http://localhost:8000/api/v1/his/code-review`
3. 配置请求格式：
   ```json
   {
     "code_path": "{{filePath}}",
     "code_content": "{{fileContent}}"
   }
   ```
4. 使用AI助手进行代码审查

### IDEA插件配置

使用IDEA的HTTP Client或自定义插件：

1. 创建HTTP请求配置：
   ```http
   POST http://localhost:8000/api/v1/his/code-review
   Content-Type: application/json
   
   {
     "code_path": "$FILE_PATH$",
     "code_content": "$FILE_CONTENT$"
   }
   ```
2. 或使用Live Templates快速调用API

### 通用HTTP调用

任何支持HTTP请求的工具都可以调用此API：

```python
import requests

# HIS代码审查
response = requests.post(
    "http://localhost:8000/api/v1/his/code-review",
    json={
        "code_path": "OrderService.java",
        "code_content": "public class OrderService { ... }"
    }
)
print(response.json())

# HIS知识问答
response = requests.post(
    "http://localhost:8000/api/v1/his/knowledge-qa",
    json={
        "question": "什么是HL7标准？",
        "use_knowledge_base": True,
        "knowledge_base_name": "his_knowledge"
    }
)
print(response.json())
```

## 知识库管理

### 创建知识库

```bash
curl -X POST http://localhost:8000/api/v1/knowledge/create \
  -H "Content-Type: application/json" \
  -d '{
    "name": "his_knowledge",
    "path": "./docs/his",
    "description": "HIS系统知识文档"
  }'
```

### 查询知识库

```bash
curl -X POST http://localhost:8000/api/v1/knowledge/his_knowledge/query \
  -H "Content-Type: application/json" \
  -d '{
    "query": "什么是HL7标准？",
    "top_k": 5
  }'
```

## 提示词管理

### 创建提示词模板

```bash
curl -X POST http://localhost:8000/api/v1/prompt/create \
  -H "Content-Type: application/json" \
  -d '{
    "name": "my_template",
    "category": "development",
    "system_prompt": "你是一个HIS开发专家",
    "user_prompt_template": "帮我{task}"
  }'
```

### 格式化提示词

```bash
curl -X POST http://localhost:8000/api/v1/prompt/format \
  -H "Content-Type: application/json" \
  -d '{
    "template_name": "my_template",
    "variables": {"task": "写一个Java类"}
  }'
```

## HIS业务功能

系统预置了以下HIS专业功能：

1. **代码审查**：HIS代码质量、业务逻辑、安全性审查
2. **开发助手**：HIS功能开发咨询和方案设计
3. **知识问答**：HIS专业知识问答
4. **流程设计**：临床业务流程设计
5. **数据库设计**：HIS数据库设计咨询
6. **API设计**：HIS接口设计咨询

## Anaconda环境管理

### 常用命令

```bash
# 创建环境
conda env create -f environment.yml

# 激活环境
conda activate hisagent

# 停用环境
conda deactivate

# 查看环境列表
conda env list

# 导出环境配置
conda env export > environment.yml

# 更新环境（修改environment.yml后）
conda env update -f environment.yml --prune

# 删除环境
conda env remove -n hisagent
```

### 环境文件说明

`environment.yml` 包含了项目所需的所有依赖：
- Python 3.10
- FastAPI Web框架
- ZhipuAI SDK（智谱AI）
- LlamaIndex（知识库管理）
- ChromaDB（向量数据库）
- 其他必要依赖

## 许可证

MIT License
